<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âLEVAGE BOSKO - R√©sultats de Course</title> 
    <style>
        /* Styles G√©n√©raux */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 900px; margin: auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2 { color: #0056b3; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="text"], input[type="datetime-local"], button, select { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #28a745; color: white; cursor: pointer; border: none; }
        button:hover { background-color: #218838; }
        
        #save-constatation-btn { background-color: #ffc107; color: #333; }
        #save-constatation-btn:hover { background-color: #e0a800; }

        /* Styles du Tableau de R√©sultats */
        .resultats-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .resultats-table th, .resultats-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .resultats-table th { background-color: #f2f2f2; }
        
        /* Styles de classement (Podium en Jaune Pur et Gras) */
        .rang-1, .rang-2, .rang-3 { 
            background-color: #FFFF00 !important; 
            font-weight: bold; 
        } 

        /* --- STYLES D'IMPRESSION --- */
        @media print {
            .container { box-shadow: none; border: none; }
            #data-input, #constatation-form, #pdf-button, hr { display: none !important; }
            body { margin: 0; padding: 0; background: white; }
            @page { margin: 0; size: A4 portrait; }
            
            .print-header { 
                display: flex; 
                justify-content: space-between; 
                align-items: center; 
                border-bottom: 3px solid #0056b3; 
                padding-bottom: 10px; 
                margin-bottom: 20px;
                padding-left: 20px; 
                padding-right: 20px;
            }
            .print-logo { 
                max-height: 120px; 
                width: auto; 
                margin-right: 20px; 
            }
            .print-title h1 { 
                color: #0056b3; 
                margin: 0; 
                font-size: 24pt;
                text-transform: uppercase;
            }
            .print-title p {
                margin: 5px 0 0;
                font-size: 10pt;
                color: #555;
            }
            .resultats-table { 
                border: 2px solid #0056b3; 
                margin-top: 15px;
                font-size: 10pt; 
                margin-left: 20px; 
                margin-right: 20px;
                width: calc(100% - 40px);
            }
            .resultats-table th, .resultats-table td { 
                border-color: #ccc; 
                padding: 5px; 
            }
            .rang-1, .rang-2, .rang-3 {
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            .container { width: 100%; max-width: none; padding: 0; }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
</head>
<body>

    <div class="container">
        <h1>üèÅ √âLEVAGE BOSKO - Calculateur de R√©sultats EN DIRECT</h1>
        
        <p>‚úÖ Le classement s'affiche et se met √† jour automatiquement gr√¢ce √† la base de donn√©es en ligne (Firebase).</p>

        <div id="data-input">
            <h2>Param√®tres du L√¢cher (Fixes)</h2>
            <label for="heure-lacher">Heure de L√¢cher :</label>
            <input type="datetime-local" id="heure-lacher" value="2025-11-21T08:00">

            <label for="lacher-lat">Latitude du L√¢cher (D√©cimal)</label>
            <input type="text" id="lacher-lat" value="50.45">

            <label for="lacher-lon">Longitude du L√¢cher (D√©cimal)</label>
            <input type="text" id="lacher-lon" value="3.25">
        </div>
        
        <hr>

        <div id="constatation-form">
            <h2>Nouvelle Constatation (Temps R√©el)</h2>
            <label for="amateur-name">Nom de l'Amateur (Charg√© depuis Firebase) :</label>
            <select id="amateur-name">
                <option value="" disabled selected>Chargement des amateurs...</option>
            </select>
            
            <label for="bague-number">N¬∞ Bague :</label>
            <input type="text" id="bague-number" placeholder="Ex: 1001">
            
            <label for="constatation-time">Heure de Constatation (YYYY-MM-DDTHH:MM) :</label>
            <input type="datetime-local" id="constatation-time">

            <button onclick="saveConstatationToDB()" id="save-constatation-btn">
                ‚úÖ Enregistrer la Constatation en Ligne
            </button>
        </div>

        <hr>

        <h2>üìä Classement EN DIRECT</h2>
        <div id="resultats">
            <p style="color:orange;">Initialisation de la connexion Firebase...</p>
        </div>
        
        <button onclick="generatePrintReport()" id="pdf-button" style="margin-top: 20px;">G√©n√©rer le PDF (Imprimer) - Design Moderne</button>
    </div>

    <script>
        // =================================================================
        // ‚ö†Ô∏è CONFIGURATION FIREBASE (REPRISE DE VOTRE CODE PR√âC√âDENT)
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCeIrq2tmx0JS6rOwWLp2V4Ik81537hlyQ",
            authDomain: "pigeonnierdata.firebaseapp.com",
            projectId: "pigeonnierdata",
            storageBucket: "pigeonnierdata.firebasestorage.app",
            messagingSenderId: "1032790295918",
            appId: "1:1032790295918:web:b341cb4424650a72206d7f",
            measurementId: "G-DN55HRVPR1"
        };

        // Initialisation de Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // =================================================================
        

        // REMPLACER CECI par l'URL de votre logo !
        const LOGO_URL = 'https://via.placeholder.com/150x80?text=VOTRE+LOGO'; 
        
        // =================================================================
        // Base de Donn√©es des Pigeonniers : Vide initialement, sera charg√©e depuis Firestore
        // =================================================================
        let PIGEONNIER_DATA = {}; 
        
        // Fonction d'initialisation : Charge les donn√©es des pigeonniers et d√©marre l'√©coute des r√©sultats
        window.onload = function() {
            // D√©marre le chargement des coordonn√©es des pigeonniers depuis Firebase
            loadPigeonniersData();
        };

        /**
         * Charge les coordonn√©es de tous les pigeonniers depuis la collection 'pigeonniers'.
         */
        function loadPigeonniersData() {
            db.collection("pigeonniers").get().then((snapshot) => {
                const select = document.getElementById('amateur-name');
                // Vider l'option de chargement
                select.innerHTML = '';
                select.disabled = false;
                
                PIGEONNIER_DATA = {};
                
                snapshot.forEach(doc => {
                    const amateurName = doc.id; // L'ID du document est le nom de l'amateur
                    const data = doc.data();
                    
                    // Stockage des donn√©es (IMPORTANT : conversion en nombre pour le calcul)
                    PIGEONNIER_DATA[amateurName] = { 
                        lat: parseFloat(data.lat),
                        lon: parseFloat(data.lon)
                    };

                    // Remplir le menu d√©roulant
                    const option = document.createElement('option');
                    option.value = amateurName;
                    option.textContent = amateurName;
                    select.appendChild(option);
                });
                
                if (Object.keys(PIGEONNIER_DATA).length === 0) {
                    select.innerHTML = '<option value="" disabled selected>AUCUN AMATEUR TROUV√â (V√©rifiez la collection "pigeonniers")</option>';
                    select.disabled = true;
                    document.getElementById('resultats').innerHTML = '<p style="color:red;">ERREUR: La collection "pigeonniers" est vide ou inaccessible.</p>';
                } else {
                    document.getElementById('resultats').innerHTML = '<p style="color: green;">Donn√©es des pigeonniers charg√©es. D√©marrage de l\'√©coute en temps r√©el...</p>';
                }

                // Une fois les coordonn√©es charg√©es, nous d√©marrons l'√©coute des constatations
                listenForResults(); 

            }).catch(error => {
                console.error("Erreur lors du chargement des donn√©es des pigeonniers:", error);
                document.getElementById('resultats').innerHTML = `<p style="color:red;">Erreur: Impossible de charger les coordonn√©es des pigeonniers (Network ou R√®gles Firestore). Consultez la console.</p>`;
            });
        }


        /**
         * Calcule la distance entre deux points GPS (Latitude/Longitude) en utilisant la formule Haversine.
         */
        function getDistanceHaversine(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; 
        }
        
        // =================================================================
        // FONCTIONS FIREBASE
        // =================================================================

        /**
         * Enregistre une nouvelle constatation dans la base de donn√©es Firestore.
         */
        function saveConstatationToDB() {
            const amateur = document.getElementById('amateur-name').value;
            const bague = document.getElementById('bague-number').value.trim();
            const constatationTimeStr = document.getElementById('constatation-time').value;
            
            if (!amateur || !bague || !constatationTimeStr) {
                alert("Veuillez remplir tous les champs de la constatation.");
                return;
            }
            
            // V√©rification que les coordonn√©es de l'amateur sont disponibles (d√©j√† charg√©es)
            if (!PIGEONNIER_DATA[amateur]) {
                alert(`Erreur critique: Les coordonn√©es de l'amateur "${amateur}" sont introuvables. Rechargez la page.`);
                return;
            }

            // Convertir l'heure de constatation en objet Date pour Firebase (timestamp)
            const constatationDate = new Date(constatationTimeStr);

            db.collection("constatations").add({
                bague: bague,
                amateur: amateur,
                constatation_time: constatationDate, // Firestore stocke ceci comme un Timestamp
                timestamp_enregistrement: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                // Effacer le formulaire apr√®s succ√®s
                document.getElementById('bague-number').value = '';
                document.getElementById('constatation-time').value = '';
                alert(`Constatation de ${amateur} (${bague}) enregistr√©e !`);
            })
            .catch((error) => {
                alert("Erreur lors de l'enregistrement de la constatation. Voir la console pour les d√©tails.");
                console.error("Erreur d'√©criture: ", error);
            });
        }

        /**
         * √âcoute la base de donn√©es Firestore en temps r√©el.
         * D√®s qu'une donn√©e change, la fonction calculateResults est appel√©e.
         */
        function listenForResults() {
            // Si les donn√©es de base (pigeonniers) n'ont pas √©t√© charg√©es, on ne fait rien.
            if (Object.keys(PIGEONNIER_DATA).length === 0) {
                 return;
            }
            
            // Requ√™te pour trier les r√©sultats par heure de constatation.
            db.collection("constatations").orderBy("constatation_time", "asc")
              .onSnapshot((snapshot) => {
                let toutesLesConstatations = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Assurez-vous que l'heure de constatation est convertie en string ISO pour le calcul
                    const isoTime = data.constatation_time.toDate().toISOString().substring(0, 16); 
                    toutesLesConstatations.push({
                        bague: data.bague,
                        amateur: data.amateur,
                        constatation: isoTime // Format 'YYYY-MM-DDTHH:MM'
                    });
                });
                
                calculateResults(toutesLesConstatations);
            }, (error) => {
                console.error("Erreur lors de l'√©coute de la base de donn√©es 'constatations':", error);
                document.getElementById('resultats').innerHTML = `<p style="color:red;">Erreur de connexion √† Firebase. V√©rifiez la console.</p>`;
            });
        }


        // =================================================================
        // FONCTIONS DE CALCUL (utilise PIGEONNIER_DATA remplie par Firebase)
        // =================================================================
        
        /**
         * Calcule et affiche les r√©sultats √† partir des donn√©es de constatation.
         */
        function calculateResults(constatations) {
            const heureLacherInput = document.getElementById('heure-lacher').value;
            const lacherLat = parseFloat(document.getElementById('lacher-lat').value);
            const lacherLon = parseFloat(document.getElementById('lacher-lon').value);
            const resultsDiv = document.getElementById('resultats');
            
            if (!heureLacherInput || isNaN(lacherLat) || isNaN(lacherLon)) {
                resultsDiv.innerHTML = '<p style="color:red;">Veuillez v√©rifier les param√®tres du l√¢cher.</p>';
                return;
            }
            if (constatations.length === 0) {
                 resultsDiv.innerHTML = '<p>Aucune constatation enregistr√©e pour le moment. Le classement sera mis √† jour d√®s la premi√®re arriv√©e.</p>';
                 return;
            }

            const lacherTime = new Date(heureLacherInput).getTime();
            
            let pigeons = [];

            constatations.forEach(constatation => {
                const amateur = constatation.amateur;
                const bague = constatation.bague;

                // 1. R√©cup√©rer les coordonn√©es du pigeonnier
                const pigeonnier = PIGEONNIER_DATA[amateur];
                if (!pigeonnier) return; // Ignore si l'amateur n'est pas dans la base charg√©e

                const pigeonnierLat = pigeonnier.lat;
                const pigeonnierLon = pigeonnier.lon;
                
                const constatationTime = new Date(constatation.constatation).getTime();
                
                const distanceKm = getDistanceHaversine(lacherLat, lacherLon, pigeonnierLat, pigeonnierLon);
                
                if (isNaN(distanceKm) || distanceKm <= 0 || isNaN(constatationTime) || constatationTime < lacherTime) {
                    return; 
                }

                // Calculs de temps et vitesse
                const tempsVolMs = constatationTime - lacherTime;
                const distanceM = distanceKm * 1000;
                const tempsVolMin = tempsVolMs / (1000 * 60);
                let vitesse = (tempsVolMin > 0) ? (distanceM / tempsVolMin) : 0;

                const totalSeconds = Math.floor(tempsVolMs / 1000);
                const h = Math.floor(totalSeconds / 3600);
                const m = Math.floor((totalSeconds % 3600) / 60);
                const s = totalSeconds % 60;
                const tempsVolFormatted = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;

                pigeons.push({
                    bague,
                    amateur,
                    distanceKm: distanceKm.toFixed(3), 
                    constatation: constatation.constatation.replace('T', ' '),
                    tempsVol: tempsVolFormatted,
                    vitesse: vitesse.toFixed(3)
                });
            });

            // Tri par Vitesse (Classement)
            pigeons.sort((a, b) => parseFloat(b.vitesse) - parseFloat(a.vitesse));

            // Affichage des R√©sultats
            let html = `
                <p style="font-weight: bold; color: green;">Mise √† jour automatique - Total Constatations valides: ${pigeons.length}</p>
                <table class="resultats-table">
                    <thead>
                        <tr>
                            <th>Rang</th>
                            <th>N¬∞ Bague</th>
                            <th>Amateur</th>
                            <th>Distance (km)</th>
                            <th>Constatation</th>
                            <th>Temps de Vol</th>
                            <th>Vitesse (m/min)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            pigeons.forEach((p, index) => {
                let rankClass = '';
                const rank = index + 1;

                if (rank === 1) {
                    rankClass = 'rang-1';
                } else if (rank === 2) {
                    rankClass = 'rang-2';
                } else if (rank === 3) {
                    rankClass = 'rang-3';
                }

                html += `
                    <tr class="${rankClass}"> 
                        <td>${rank}</td>
                        <td>${p.bague}</td>
                        <td>${p.amateur}</td>
                        <td>${p.distanceKm}</td>
                        <td>${p.constatation}</td>
                        <td>${p.tempsVol}</td>
                        <td>${p.vitesse}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;
            resultsDiv.innerHTML = html;
        }

        // =================================================================
        // FONCTION D'IMPRESSION (inchang√©e)
        // =================================================================

        function generatePrintReport() {
            const resultsDiv = document.getElementById('resultats');
            const lacherDate = document.getElementById('heure-lacher').value.split('T')[0];
            const lacherTime = document.getElementById('heure-lacher').value.split('T')[1];
            const lacherLat = document.getElementById('lacher-lat').value;
            const lacherLon = document.getElementById('lacher-lon').value;

            const printHeader = `
                <div class="print-header">
                    <div class="print-title">
                        <h1>√âLEVAGE BOSKO</h1>
                        <p>
                            R√âSULTATS OFFICIELS DE LA COURSE
                            <br>
                            Date du L√¢cher: ${lacherDate} √† ${lacherTime} | Lieu: Lat ${lacherLat}, Lon ${lacherLon}
                            </p>
                    </div>
                    <img src="${LOGO_URL}" class="print-logo" alt="Logo du Club">
                </div>
            `;
            
            const originalContent = document.body.innerHTML;
            const contentToPrint = resultsDiv.innerHTML;
            
            document.body.innerHTML = printHeader + contentToPrint;
            
            window.print();
            
            document.body.innerHTML = originalContent;
        }
    </script>
</body>
</html>
